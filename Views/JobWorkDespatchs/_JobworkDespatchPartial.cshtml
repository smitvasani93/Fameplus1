@model  Transactiondetails.ViewModels.JobReciptVM
@using Newtonsoft.Json;

@{
    var jsonMode = JsonConvert.SerializeObject(Model.Mode);
    var jsonModel = JsonConvert.SerializeObject(Model);
    var htmlAttributes = new Dictionary<string, object>();
    htmlAttributes.Add("class", "form-control");
    htmlAttributes.Add("readonly", true);
    //if (Model.Mode == Transactiondetails.ViewModels.Mode.Update)
    //{
    //    htmlAttributes.Add("readonly", true);
    //}
}

@using (Ajax.BeginForm("SaveJobworkReceipt", "JobWorkDespatchs", new AjaxOptions { HttpMethod = "Post", UpdateTargetId = "result", OnSuccess = "AjaxFormSuccess" }, new { id = "JobworkReceiptPop" }))
{
    @Html.HiddenFor(model => model.Mode)
    <div class="row g-3">
        <div class="col-lg-12">
            <div class="row">
                <div class="col-sm-2">
                    <label for="inputEmail3" class="col-form-label">Receipt Date</label>
                </div>
                <div class="col-sm-5">
                    @Html.TextBoxFor(x => x.ReferenceDate, "{0:dd/MM/yyyy}", new { @id = "ReferenceDate11", @class = "form-control", @readonly = true })
                </div>
                <div class="col-sm-2 mr-minus">
                    <label for="inputEmail3" class="col-form-label">Receipt No</label>
                </div>
                <div class="col-sm-3">
                    @Html.TextBoxFor(x => x.SerialNumber, htmlAttributes)
                </div>
            </div>
        </div>
        <div class="col-lg-12">
            <div class="row">
                <label for="inputEmail3" class="col-sm-2 col-form-label">Customer Name</label>
                <div class="col-sm-5">
                    @Html.DropDownList("AccountCode", new SelectList(Model.Accounts, "AccountCode", "AccountName", Model.AccountCode), "Please select", new { @id = "ddlCustomer", @class = "form-select"})
                    @*@Html.HiddenFor(model=>model.AccountCode)*@
                </div>
            </div>
        </div>
        <div class="col-lg-12">
            <div id="newone" class="row pt-1 newone-css" >
                <table id="receipt" class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width:400px;">Process</th>
                            <th style="width:400px;">Process</th>
                            <th>Packet No</th>
                            <th>Pieces</th>
                            <th>Carats</th>
                            <th>Lines</th>
                            <th>Remarks</th>
                            <th></th>
                        </tr>
                    </thead>
                    @for (var i = 0; i < Model.JobReceiptDetails.Count(); i++)
                    {
                <tr class="receipt-@Model.JobReceiptDetails[i].ProcessCode">
                    <td>
                        @Html.DropDownListFor(model => Model.JobReceiptDetails[i].ProcessCode, new SelectList(Model.Processes, "ProcessCode", "ProcessName", Model.JobReceiptDetails[i].ProcessCode), "Please select", new { @class = "form-select", @required = true, @disabled = true })
                        @Html.HiddenFor(model => Model.JobReceiptDetails[i].ProcessCode)
                    </td>
                    <td>
                        @Html.TextBoxFor(model => Model.JobReceiptDetails[i].PacketNumber, new { @required = true, @class = "form-control numberonly" })
                    </td>
                    <td>
                        @Html.TextBoxFor(model => Model.JobReceiptDetails[i].ItemPieces, new { @required = true, @class = "form-control allow_decimal" })
                    </td>
                    <td>
                        @Html.TextBoxFor(model => Model.JobReceiptDetails[i].ItemCarats, new { @required = true, @class = "form-control allow_decimal" })
                    </td>
                    <td>
                        @Html.TextBoxFor(model => Model.JobReceiptDetails[i].ItemLines, new { @required = true, @class = "form-control allow_decimal" })
                    </td>
                    <td>
                        @Html.TextBoxFor(model => Model.JobReceiptDetails[i].Remarks, new { @class = "form-control" })
                    </td>
                    <td>
                        @Html.TextBoxFor(model => Model.JobReceiptDetails[i].Remarks, new { @class = "form-control" })
                    </td>
                    <td class="plsRow">
                    </td>
                    <td style="display:none">
                        @Html.HiddenFor(model => Model.JobReceiptDetails[i].ItemSerialNumber)
                    </td>
                </tr>
                    }
                </table>

            </div>
            <div class="jqueryTbl-container">
                <table id="jqueryTbl"></table>
                <div class="ui-dialog-buttonset offset-lg-11 pt-lg-3 pb-lg-1 ps-3">
                    <button type="button" class="btn btn-default select-pending-receipt">Select</button>
                </div>
            </div>

        </div>
        <div class="col-lg-12 button-container newone-css" >
            <div class="ui-dialog-buttonpane ui-widget-content ui-helper-clearfix">
                <div class="ui-dialog-buttonset ps-sm-5">
                    <button type="submit" class="btn btn-secondary">Submit</button>
                    <button type="button" class="btn btn-default btn-close-dialog ">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div id="result">

    </div>
}

<script type="text/javascript">

    var mode =@(Html.Raw(jsonMode));

    $(function () {

        var data =@(Html.Raw(jsonModel));
        var pageWidth = $("#jqueryTbl").parent().width() - 100;
        var currids = [];
        $("#jqueryTbl").jqGrid({
            data: [],
            datatype: 'local',
            colModel: [
                /*{ label: 'Tag', name: "Tag", width: 50, align: "center", sortable: false, formatter: "checkbox", formatoptions: { disabled: false }, edittype: "checkbox", editoptions: { value: "True:False" }, formatoptions: { disabled: false }, multiselect: true },*/
                { label: "Ref Date", name: "ReferenceDate", width: (pageWidth * (15 / 100)), align: "center", formatter: "date", formatoptions: { srcformat: "m/d/Y h:i:s A", newformat: "Y-m-d" } },
                { label: "Customer", width: (pageWidth * (20 / 100)), align: "center", name: "CustomrName" },
                { label: "Process ", width: (pageWidth * (24 / 100)), align: "center",  name: "ProcessName"},
                { label: "Packet No", width: (pageWidth * (10 / 100)), align: "center", name: "PacketNumber"},
                { label: "Pieces", width: (pageWidth * (6 / 100)), align: "center", name: "ItemPieces"},
                { label: "Pending Pieces", width: (pageWidth * (10 / 100)), align: "center", name: "Bal_ItemPieces"},
                { label: "Carats", width: (pageWidth * (5 / 100)), align: "center", name: "ItemCarats"},
                { label: "Pending Carats", width: (pageWidth * (10 / 100)), align: "center", name: "Bal_ItemCarats" },
                { label: "Lines", width: (pageWidth * (5 / 100)), align: "center", name: "ItemLines" },
                { name: "ItemSerialNumber", hidden: 'true'},
                { name: "ProcessCode", hidden: 'true' }
            ],
            cmTemplate: { sortable: false },
            loadonce: true,
            height: '100%',
            width: '100%',
            multiselect: true,
            multiselectWidth: 30,
            shrinkToFit: true,
            onSelectRow: function (rowid, status, e) {

               // $('#cb_' + $.jgrid.jqID(this.p.id), this.grid.hDiv)[this.p.useProp ? 'prop' : 'attr']("checked", true);
                //var ch = jQuery(this).find('input[type=checkbox]').prop('checked');
                //if (ch) {
                //    jQuery(this).find('input[type=checkbox]').prop('checked', false);
                //    jQuery(this).removeClass("ui-state-highlight");
                //    $(e.currentTarget)
                //} else {
                //    jQuery(this).find('input[type=checkbox]').prop('checked', true);
                //}
                //debugger;
                /*
                if (this.p.selarrrow.length === currids.length) {
                    $('#cb_' + $.jgrid.jqID(this.p.id), this.grid.hDiv)[this.p.useProp ? 'prop' : 'attr']("checked", true);
                }*/
            },
            gridComplete: function () {
             /*   currids = $(this).jqGrid('getDataIDs');*/
            }
        });


        $(".select-pending-receipt").on("click", function (e) {
            getSelectedRows();

            //var myGrid = $('#jqueryTbl'), i, rowData, names = [],
            //    rowIds = myGrid.jqGrid("getDataIDs"),
            //    n = rowIds.length;

            ////console.log(JSON.stringify(rowIds));
            //for (i = 0; i < n; i++) {
            //    rowData = myGrid.jqGrid("getLocalRow", rowIds[i]);
            //    if (rowData.active) {
            //        names.push(rowData.name);
            //    }
            //    console.log('selected row data:'+ JSON.stringify(rowData));
            //}

            //console.log(names);
        });

        function getSelectedRows() {

            debugger;
            var $grid = $("#jqueryTbl");
            var rowKey = $grid.getGridParam("selrow");
            var jobReceiptDetail = [];
         
            if (!rowKey) {
                alert("No rows are selected");
                return;
            }
        
            let selectedRows = $("#jqueryTbl").jqGrid("getGridParam", "selarrrow");
            
            // loop through the IDs to retrieve the data for each selected row
            for (var i = 0; i < selectedRows.length; i++) {
                var rowData = $("#jqueryTbl").jqGrid("getRowData", selectedRows[i]);
                // do something with the row data, for example:
                //console.log("Selected row ID: " + selectedRows[i]);
                //console.log("Selected row data: " + JSON.stringify(rowData));
            }


            for (let j = 0; j < jobReceiptDetail.length; j++) {
                $("#receipt tbody tr").each(function (indx, row) {
                    if ($(row).hasClass("receipt-" + jobReceiptDetail[j])) {
                        $(row).remove();
                    }
                });
            }

            $(".jqueryTbl-container").remove();
            $("#newone").removeClass("newone-css");
            $(".button-container").removeClass("newone-css");
            resetElementIndex();
        }
    });


    $("#ddlCustomer").on("change", function (e) {
        
        let accountcode = this.value;
        $.ajax({
            url: "@Url.Action("GetPendingJobworkReceipt", "JobWorkDespatchs")",
            type: "POST",
            data: { accountCode: accountcode },
            dataType: 'json',
            success: function (data) {

                var $gParams = $('#jqueryTbl').jqGrid("getGridParam");
                $gParams.data = data;
                $('#jqueryTbl').trigger("reloadGrid", [{ page: 1 }]);
            }
        });
    });

    function resetElementIndex() {
        let index = 0;

        $("#receipt tbody tr").each(function (i, row) {
            let $actualrow = $(row);
            $actualrow.find("td").each(function (column, td) {

                let $selectName = $(this).find("input,select").attr("name");
                let $name = $(this).find("input,text").attr("name");
                let $hidenname = $(this).find("input,hidden").attr("name");
                let $ctrl = undefined;

                if ($hidenname !== undefined && $hidenname.indexOf(".ItemSerialNumber") != -1) {
                    $(this).find("input,hidden").attr("id", "JobReceiptDetails_" + index + "__ItemSerialNumber");
                    $(this).find("input,hidden").attr("name", "JobReceiptDetails[" + index + "].ItemSerialNumber");
                    $ctrl = $(this).find("input,hidden").attr("name","JobReceiptDetails[" + index + "].ItemSerialNumber");
                    $($ctrl).val(index);
                }

                if ($selectName !== undefined && $selectName.indexOf(".ProcessCode") != -1) {
                    $(this).find("input,select").attr("id", "JobReceiptDetails_" + index + "__ProcessCode");
                    $(this).find("input,select").attr("name", "JobReceiptDetails[" + index + "].ProcessCode");
                    $ctrl = $(this).find("input,select").attr("name", "JobReceiptDetails[" + index + "].ProcessCode");
                }

                if ($name !== undefined && $name.indexOf(".PacketNumber") != -1) {
                    $(this).find("input,text").attr("id", "JobReceiptDetails_" + index + "__PacketNumber");
                    $(this).find("input,text").attr("name", "JobReceiptDetails[" + index + "].PacketNumber");
                    $ctrl = $(this).find("input,text").attr("name","JobReceiptDetails[" + index + "].PacketNumber");
                }

                if ($name !== undefined && $name.indexOf(".ItemPieces") != -1) {
                    $(this).find("input,text").attr("id", "JobReceiptDetails_" + index + "__ItemPieces");
                    $(this).find("input,text").attr("name", "JobReceiptDetails[" + index + "].ItemPieces");
                    $ctrl = $(this).find("input,text").attr("name","JobReceiptDetails[" + index + "].ItemPieces");
                }

                if ($name !== undefined && $name.indexOf(".ItemCarats") != -1) {
                    $(this).find("input,text").attr("id", "JobReceiptDetails_" + index + "__ItemCarats");
                    $(this).find("input,text").attr("name", "JobReceiptDetails[" + index + "].ItemCarats");
                    $ctrl = $(this).find("input,text").attr("name","JobReceiptDetails[" + index + "].ItemCarats");
                }

                if ($name !== undefined && $name.indexOf(".ItemLines") != -1) {
                    $(this).find("input,text").attr("id", "JobReceiptDetails_" + index + "__ItemLines");
                    $(this).find("input,text").attr("name", "JobReceiptDetails[" + index + "].ItemLines");
                    $ctrl = $(this).find("input,text").attr("name","JobReceiptDetails[" + index + "].ItemLines");
                }

                if ($name !== undefined && $name.indexOf(".Remark") != -1) {
                    $(this).find("input,text").attr("id", "JobReceiptDetails_" + index + "__Remark");
                    $(this).find("input,text").attr("name", "JobReceiptDetails[" + index + "].Remark");
                    $ctrl = $(this).find("input,text").attr("name", "JobReceiptDetails[" + index + "].Remark");
                }

                if ($ctrl !== undefined &&
                    !$($ctrl).is(":hidden") &&
                    !$($ctrl).is("[name*=Remark]")) {
                    $($ctrl).rules("add", { required: true, messages: { required: "" } });
                }

            });
            index++;
        });
    }

    function AjaxFormSuccess(e) {

        $('#dialog').dialog('close');
    }

    jQuery(document).ready(function () {

        jQuery("#JobworkReceiptPop").validate({
           rules: {
                ReferenceDate: 'required',
                AccountCode: 'required',
                SerialNumber: 'required',
            }, messages: {
                ReferenceDate: 'Select Reference Date',
                AccountCode: 'Select Customer',
                SerialNumber: 'Select Serial Number',
            }
        });


        $("#receipt tbody tr").each(function (i, row) {

            let $actualrow = $(row);
            $actualrow.find("td").each(function (column, td) {

                let select = $(td).find("select");
                let text = $(td).find("input[type=text]").not('[name*=Remark]');

                if (select.length != 0) {
                    $(select).rules("add", { required: true, messages: { required: "" } });
                }
                if (text.length != 0) {
                    $(text).rules("add", { required: true, messages: { required: "" } });
                }
            });
        });
    });

    $(document).on("click", ".btn-close-dialog", function (e) {
        $('#dialog').dialog('close');
    })


    Array.prototype.removeByValue = function (val) {
        for (var i = 0; i < this.length; i++) {
            if (this[i] === val) {
                this.splice(i, 1);
                i--;
            }
        }
        return this;
    }

</script>
<style>
    #JobworkReceiptPop .form-control:read-only {
        background-color: #e9ecef !important;
    }

    #JobworkReceiptPop .ui-jqgrid .ui-jqgrid-htable th {
        height: 40px !important;
        /* padding: 0 2px 0 2px; */
    }

    #JobworkReceiptPop .ui-jqgrid tr.jqgrow td {
        padding:4px !important;
    }
    #JobworkReceiptPop .ui-jqgrid .ui-jqgrid-view {
        font-size: 13px !important;
    }

    #JobworkReceiptPop .ui-widget input {
        margin-top:5px !important;
    }

    #JobworkReceiptPop .ui-widget-content {
        border: 1px solid #efefef !important;
    }

    .newone-css{
        display:none;
    }
</style>